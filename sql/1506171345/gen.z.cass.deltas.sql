-- 
-- z_cass report_id
-- z_cass cassette
-- z_cass slot
-- z_cass subslot
-- z_cass comp_id
-- z_cass reel_id
-- z_cass feeder_id
-- z_cass stocked
-- z_cass remaining
-- z_cass comp_exhaust
-- z_cass pickup_count
-- z_cass place_count
-- z_cass pickup_error_count
-- z_cass pickup_miss_count
-- z_cass recog_error_count
-- z_cass shape_error_count
-- z_cass height_miss_count
-- z_cass coplanarity
-- z_cass need_for_current_product
-- z_cass other_error_count
-- z_cass colinearity_count
-- z_cass pickup_attempt_count
-- z_cass place_search_attempt_count
-- z_cass place_search_failure_count
-- z_cass vision_failures
-- z_cass initial_part_count
-- z_cass used_parts_count
-- z_cass table_no
-- z_cass table_slot
-- z_cass table_subslot
-- z_cass primary_pn
-- 
-- z_cass_header mgmt_report_id
-- z_cass_header report_id
-- z_cass_header product_id
-- z_cass_header equipment_id
-- z_cass_header lane_no
-- z_cass_header start_time
-- z_cass_header end_time
-- z_cass_header setup_id
-- z_cass_header nc_version
-- z_cass_header job_id
-- z_cass_header report_file
-- 
-- z_cass_header_kx_by_board mgmt_report_id
-- z_cass_header_kx_by_board report_id
-- z_cass_header_kx_by_board product_id
-- z_cass_header_kx_by_board equipment_id
-- z_cass_header_kx_by_board lane_no
-- z_cass_header_kx_by_board start_time
-- z_cass_header_kx_by_board end_time
-- z_cass_header_kx_by_board setup_id
-- z_cass_header_kx_by_board nc_version
-- z_cass_header_kx_by_board job_id
-- z_cass_header_kx_by_board report_file
-- 
-- z_cass_header_raw mgmt_report_id
-- z_cass_header_raw report_id
-- z_cass_header_raw product_id
-- z_cass_header_raw equipment_id
-- z_cass_header_raw lane_no
-- z_cass_header_raw start_time
-- z_cass_header_raw end_time
-- z_cass_header_raw setup_id
-- z_cass_header_raw nc_version
-- z_cass_header_raw job_id
-- z_cass_header_raw report_file
-- 
-- z_cass_kx_by_board report_id
-- z_cass_kx_by_board cassette
-- z_cass_kx_by_board slot
-- z_cass_kx_by_board subslot
-- z_cass_kx_by_board comp_id
-- z_cass_kx_by_board reel_id
-- z_cass_kx_by_board feeder_id
-- z_cass_kx_by_board stocked
-- z_cass_kx_by_board remaining
-- z_cass_kx_by_board comp_exhaust
-- z_cass_kx_by_board pickup_count
-- z_cass_kx_by_board place_count
-- z_cass_kx_by_board pickup_error_count
-- z_cass_kx_by_board pickup_miss_count
-- z_cass_kx_by_board recog_error_count
-- z_cass_kx_by_board shape_error_count
-- z_cass_kx_by_board height_miss_count
-- z_cass_kx_by_board coplanarity
-- z_cass_kx_by_board need_for_current_product
-- z_cass_kx_by_board other_error_count
-- z_cass_kx_by_board colinearity_count
-- z_cass_kx_by_board pickup_attempt_count
-- z_cass_kx_by_board place_search_attempt_count
-- z_cass_kx_by_board place_search_failure_count
-- z_cass_kx_by_board vision_failures
-- z_cass_kx_by_board initial_part_count
-- z_cass_kx_by_board used_parts_count
-- z_cass_kx_by_board table_no
-- z_cass_kx_by_board table_slot
-- z_cass_kx_by_board table_subslot
-- z_cass_kx_by_board primary_pn
-- 
-- z_cass_npm report_id
-- z_cass_npm lot
-- z_cass_npm stage
-- z_cass_npm tprod
-- z_cass_npm head
-- z_cass_npm fadd
-- z_cass_npm fsadd
-- z_cass_npm fblkcode
-- z_cass_npm fblkserial
-- z_cass_npm reelid
-- z_cass_npm tcnt
-- z_cass_npm tmiss
-- z_cass_npm rmiss
-- z_cass_npm hmiss
-- z_cass_npm fmiss
-- z_cass_npm mmiss
-- z_cass_npm board
-- z_cass_npm partsname
-- z_cass_npm place_count
-- z_cass_npm trsmiss
-- z_cass_npm timestamp
-- z_cass_npm reel_id
-- z_cass_npm feeder_id
-- 
-- z_cass_npm_by_board report_id
-- z_cass_npm_by_board lot
-- z_cass_npm_by_board stage
-- z_cass_npm_by_board tprod
-- z_cass_npm_by_board head
-- z_cass_npm_by_board fadd
-- z_cass_npm_by_board fsadd
-- z_cass_npm_by_board fblkcode
-- z_cass_npm_by_board fblkserial
-- z_cass_npm_by_board reelid
-- z_cass_npm_by_board tcnt
-- z_cass_npm_by_board tmiss
-- z_cass_npm_by_board rmiss
-- z_cass_npm_by_board hmiss
-- z_cass_npm_by_board fmiss
-- z_cass_npm_by_board mmiss
-- z_cass_npm_by_board board
-- z_cass_npm_by_board partsname
-- z_cass_npm_by_board place_count
-- z_cass_npm_by_board trsmiss
-- z_cass_npm_by_board timestamp
-- z_cass_npm_by_board reel_id
-- z_cass_npm_by_board feeder_id
-- 
-- z_cass_npm_hdr report_id
-- z_cass_npm_hdr product_id
-- z_cass_npm_hdr equipment_id
-- z_cass_npm_hdr start_time
-- z_cass_npm_hdr end_time
-- z_cass_npm_hdr setup_id
-- z_cass_npm_hdr nc_version
-- z_cass_npm_hdr lane_no
-- z_cass_npm_hdr job_id
-- z_cass_npm_hdr trx_productid
-- z_cass_npm_hdr stage
-- z_cass_npm_hdr timestamp
-- 
-- z_cass_npm_hdr_by_board report_id
-- z_cass_npm_hdr_by_board product_id
-- z_cass_npm_hdr_by_board equipment_id
-- z_cass_npm_hdr_by_board start_time
-- z_cass_npm_hdr_by_board end_time
-- z_cass_npm_hdr_by_board setup_id
-- z_cass_npm_hdr_by_board nc_version
-- z_cass_npm_hdr_by_board lane_no
-- z_cass_npm_hdr_by_board job_id
-- z_cass_npm_hdr_by_board trx_productid
-- z_cass_npm_hdr_by_board stage
-- z_cass_npm_hdr_by_board timestamp
-- 
-- z_cass_npm_hdr_raw report_id
-- z_cass_npm_hdr_raw product_id
-- z_cass_npm_hdr_raw equipment_id
-- z_cass_npm_hdr_raw start_time
-- z_cass_npm_hdr_raw end_time
-- z_cass_npm_hdr_raw setup_id
-- z_cass_npm_hdr_raw nc_version
-- z_cass_npm_hdr_raw lane_no
-- z_cass_npm_hdr_raw job_id
-- z_cass_npm_hdr_raw trx_productid
-- z_cass_npm_hdr_raw stage
-- z_cass_npm_hdr_raw timestamp
-- 
-- z_cass_npm_raw report_id
-- z_cass_npm_raw lot
-- z_cass_npm_raw stage
-- z_cass_npm_raw tprod
-- z_cass_npm_raw head
-- z_cass_npm_raw fadd
-- z_cass_npm_raw fsadd
-- z_cass_npm_raw fblkcode
-- z_cass_npm_raw fblkserial
-- z_cass_npm_raw reelid
-- z_cass_npm_raw tcnt
-- z_cass_npm_raw tmiss
-- z_cass_npm_raw rmiss
-- z_cass_npm_raw hmiss
-- z_cass_npm_raw fmiss
-- z_cass_npm_raw mmiss
-- z_cass_npm_raw board
-- z_cass_npm_raw partsname
-- z_cass_npm_raw place_count
-- z_cass_npm_raw trsmiss
-- z_cass_npm_raw timestamp
-- z_cass_npm_raw reel_id
-- z_cass_npm_raw feeder_id
-- 
-- z_cass_raw report_id
-- z_cass_raw cassette
-- z_cass_raw slot
-- z_cass_raw subslot
-- z_cass_raw comp_id
-- z_cass_raw reel_id
-- z_cass_raw feeder_id
-- z_cass_raw stocked
-- z_cass_raw remaining
-- z_cass_raw comp_exhaust
-- z_cass_raw pickup_count
-- z_cass_raw place_count
-- z_cass_raw pickup_error_count
-- z_cass_raw pickup_miss_count
-- z_cass_raw recog_error_count
-- z_cass_raw shape_error_count
-- z_cass_raw height_miss_count
-- z_cass_raw coplanarity
-- z_cass_raw need_for_current_product
-- z_cass_raw other_error_count
-- z_cass_raw colinearity_count
-- z_cass_raw pickup_attempt_count
-- z_cass_raw place_search_attempt_count
-- z_cass_raw place_search_failure_count
-- z_cass_raw vision_failures
-- z_cass_raw initial_part_count
-- z_cass_raw used_parts_count
-- z_cass_raw table_no
-- z_cass_raw table_slot
-- z_cass_raw table_subslot
-- z_cass_raw primary_pn

print N'Z_CASS_RAW DATA ...'

select
    eq.equipment_name,
    zhr.lane_no,
    zhr.report_id,
    zr.fadd,
    zr.fsadd,
    zhr.start_time,
    zhr.end_time,
    zr.reel_id,
    zr.tcnt,
    zr.place_count
from
    z_cass_npm_hdr_raw zhr
left join
    z_cass_npm_raw zr
on
    zhr.report_id = zr.report_id
left join
    equipment eq
on
    zhr.equipment_id = eq.equipment_id
order by
    zhr.equipment_id asc,
    zhr.report_id asc,
    zr.fadd asc,
    zr.fsadd asc
go

print N'Z_CASS_RAW_CTE DATA ...';
go

with 
    z_cass_cte (
        eqid, 
        lnno, 
        rid,
        fadd, 
        fsadd, 
        pkup,
        plc,
        row
    )
as (
    select
        eq.equipment_name as eqid,
        zhr.lane_no as lnno,
        zhr.report_id as rid,
        zr.fadd as fadd,
        zr.fsadd as fsadd,
        zr.tcnt as pkup,
        zr.place_count as plc,
        row_number() over (
            partition by 
                eq.equipment_name, 
                zhr.lane_no, 
                zr.fadd, 
                zr.fsadd
            order by
                eq.equipment_name asc, 
                zhr.lane_no asc, 
                zr.report_id asc,
                zr.fadd asc,
                zr.fsadd asc
        ) as row
    from
        z_cass_npm_hdr_raw zhr
    left join
        z_cass_npm_raw zr
    on
        zhr.report_id = zr.report_id
    left join
        equipment eq
    on
        zhr.equipment_id = eq.equipment_id
)
select
    *
from
    z_cass_cte
go

print N'Z_CASS_RAW_CTE GENERATED DELTA DATA ...';
go

with 
    z_cass_cte (
        eqid, 
        lnno, 
        rid,
        fadd, 
        fsadd, 
        pkup,
        plc,
        row
    )
as (
    select
        eq.equipment_name as eqid,
        zhr.lane_no as lnno,
        zhr.report_id as rid,
        zr.fadd as fadd,
        zr.fsadd as fsadd,
        zr.tcnt as pkup,
        zr.place_count as plc,
        row_number() over (
            partition by 
                eq.equipment_name, 
                zhr.lane_no, 
                zr.fadd, 
                zr.fsadd
            order by
                eq.equipment_name asc, 
                zhr.lane_no asc, 
                zr.report_id asc,
                zr.fadd asc,
                zr.fsadd asc
        ) as row
    from
        z_cass_npm_hdr_raw zhr
    inner join
        z_cass_npm_raw zr
    on
        zhr.report_id = zr.report_id
    inner join
        equipment eq
    on
        zhr.equipment_id = eq.equipment_id
)
select
    curr.row as curr_row,
    prev.row as prev_row,
    curr.eqid as curr_eqid, 
    curr.lnno as curr_lnno, 
    curr.fadd as curr_fadd, 
    curr.fsadd as curr_fsadd, 
    curr.pkup as curr_pkup,
    curr.plc as curr_plc,
    prev.fadd as prev_fadd, 
    prev.fsadd as prev_fsadd, 
    prev.pkup as prev_pkup,
    prev.plc as prev_plc,
    curr.pkup - prev.pkup as delta_pkup,
    curr.plc - prev.plc as delta_plc
from
    z_cass_cte curr
left outer join
    z_cass_cte prev
on
    curr.row = prev.row + 1
where
    curr.eqid = prev.eqid
and 
    curr.lnno = prev.lnno
and
    curr.fadd = prev.fadd
and 
    curr.fsadd = prev.fsadd
order by
    curr.eqid asc,
    curr.lnno asc,
    curr.fadd asc,
    curr.fsadd asc
go

